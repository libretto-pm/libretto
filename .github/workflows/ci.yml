name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Check formatting and lints
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features

  # Build and test on multiple platforms
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.target }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            simd: avx2
            features: default

          # Linux x86_64 with musl
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            simd: avx2
            features: default

          # Linux ARM64 (GitHub hosted runner)
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            simd: neon
            features: default

          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            simd: neon
            features: default

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            simd: avx2
            features: default

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl tools (Linux musl)
        if: contains(matrix.target, 'musl')
        run: sudo apt-get install -y musl-tools

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build
        run: cargo build --target ${{ matrix.target }} --features "${{ matrix.features }}"

      - name: Run tests
        run: cargo test --target ${{ matrix.target }} --features "${{ matrix.features }}" -- --nocapture

      - name: Run platform-specific tests
        run: cargo test --target ${{ matrix.target }} -p libretto-platform --features "${{ matrix.features }}" -- --nocapture

  # Property-based tests
  proptest:
    name: Property-based Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: proptest

      - name: Run property-based tests (libretto-core)
        run: cargo test -p libretto-core prop_ -- --nocapture
        env:
          PROPTEST_CASES: 1000

      - name: Run property-based tests (libretto-resolver)
        run: cargo test -p libretto-resolver prop_ -- --nocapture
        env:
          PROPTEST_CASES: 1000

  # Integration tests
  integration:
    name: Integration Tests
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: integration-${{ matrix.os }}

      - name: Build CLI
        run: cargo build --package libretto-cli

      - name: Run integration tests
        run: cargo test --test integration_tests -- --nocapture

      - name: Run platform tests
        run: cargo test --test platform_tests -- --nocapture

      - name: Run stress tests
        run: cargo test --test stress_tests -- --nocapture
        timeout-minutes: 10

  # CLI snapshot tests
  snapshots:
    name: Snapshot Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: snapshots

      - name: Install cargo-insta
        run: cargo install cargo-insta

      - name: Build CLI
        run: cargo build --package libretto-cli

      - name: Run snapshot tests
        run: cargo test -p libretto-cli --test snapshot_tests -- --nocapture

      - name: Check for pending snapshots
        run: cargo insta test -p libretto-cli --check

  # Security tests
  security:
    name: Security Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: security

      - name: Run security tests
        run: cargo test --test security_tests -- --nocapture

  # Test SIMD-specific code
  test-simd:
    name: SIMD Tests (${{ matrix.os }}, ${{ matrix.simd }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # AVX2 tests (x86_64)
          - os: ubuntu-latest
            simd: avx2
            rustflags: "-C target-feature=+avx2"

          # SSE4.2 tests (x86_64)
          - os: ubuntu-latest
            simd: sse42
            rustflags: "-C target-feature=+sse4.2"

          # NEON tests (ARM64)
          - os: ubuntu-24.04-arm
            simd: neon
            rustflags: ""

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: simd-${{ matrix.simd }}

      - name: Run SIMD tests
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: cargo test --package libretto-platform simd -- --nocapture

  # Benchmark performance
  bench:
    name: Benchmarks
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run benchmarks
        run: cargo bench --package libretto-platform --bench platform_bench -- --noplot

  # Cross-compilation check
  cross-compile:
    name: Cross-compile (${{ matrix.target }})
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools lld

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: cross-${{ matrix.target }}

      - name: Build
        run: cargo build --target ${{ matrix.target }} --package libretto-platform

  # Security audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run audit
        run: cargo audit

  # Documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build docs
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Coverage
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false

  # Minimum supported Rust version
  msrv:
    name: MSRV (1.89)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust 1.89
        uses: dtolnay/rust-toolchain@1.89

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: msrv

      - name: Build with MSRV
        run: cargo build --package libretto-platform

  # Release build verification
  release:
    name: Release Build
    needs: [test, test-simd]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }} --package libretto-platform

      - name: Run release tests
        run: cargo test --release --target ${{ matrix.target }} --package libretto-platform

  # Fuzz testing (limited iterations for CI)
  fuzz:
    name: Fuzz Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y lld

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: fuzz

      - name: Run fuzz tests (limited iterations)
        run: |
          cd fuzz
          for target in fuzz_version_constraint fuzz_json_parsing fuzz_package_name; do
            echo "Fuzzing $target..."
            cargo +nightly fuzz run $target -- -max_total_time=30 || true
          done
        continue-on-error: true
